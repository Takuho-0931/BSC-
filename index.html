<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BSC AIãƒ„ãƒ¼ãƒ«ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆï¼‰</title>
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + Babel (JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-white text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState } = React;

      /*** å‹ã®ä»£ã‚ã‚Šã«JSDocã§è£œåŠ© ***/
      /** @typedef {"Financial" | "Customer" | "Internal" | "Learning"} PerspectiveKey */

      const PERSPECTIVES = [
        { key: "Financial", label: "è²¡å‹™", color: "#0f766e" },
        { key: "Customer", label: "é¡§å®¢", color: "#7c3aed" },
        { key: "Internal", label: "å†…éƒ¨ãƒ—ãƒ­ã‚»ã‚¹", color: "#1d4ed8" },
        { key: "Learning", label: "å­¦ç¿’ã¨æˆé•·", color: "#b45309" },
      ];

      const KPI_SUGGESTIONS = {
        Financial: [
          { name: "å£²ä¸Šé«˜æˆé•·ç‡", unit: "%" },
          { name: "å–¶æ¥­åˆ©ç›Šç‡", unit: "%" },
          { name: "LTV", unit: "å††/é¡§å®¢" },
          { name: "CACå›åæœŸé–“", unit: "æœˆ" },
          { name: "è§£ç´„ç‡", unit: "%/æœˆ" },
        ],
        Customer: [
          { name: "NPS", unit: "ã‚¹ã‚³ã‚¢" },
          { name: "é¡§å®¢æº€è¶³åº¦(CSAT)", unit: "ç‚¹" },
          { name: "ç´¹ä»‹ç‡", unit: "%" },
          { name: "ç„¡æ–™â†’æœ‰æ–™è»¢æ›ç‡", unit: "%" },
          { name: "ç¶™ç¶šç‡(90æ—¥)", unit: "%" },
        ],
        Internal: [
          { name: "æ–°æ©Ÿèƒ½æä¾›ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ", unit: "æ—¥" },
          { name: "ä¸å…·åˆå†ç™ºç‡", unit: "%" },
          { name: "ä¸€æ¬¡è§£æ±ºç‡(ã‚µãƒãƒ¼ãƒˆ)", unit: "%" },
          { name: "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶ä½œã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒ ", unit: "æ—¥" },
          { name: "è‡ªå‹•åŒ–æ¯”ç‡", unit: "%" },
        ],
        Learning: [
          { name: "å­¦ç¿’æ™‚é–“/äºº", unit: "æ™‚é–“/æœˆ" },
          { name: "ã‚¹ã‚­ãƒ«ãƒãƒˆãƒªã‚¯ã‚¹é”æˆåº¦", unit: "%" },
          { name: "æ”¹å–„ææ¡ˆä»¶æ•°", unit: "ä»¶/æœˆ" },
          { name: "å¿ƒç†çš„å®‰å…¨æ€§ã‚¹ã‚³ã‚¢", unit: "ç‚¹" },
          { name: "æ¡ç”¨ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ", unit: "æ—¥" },
        ],
      };

      const DEFAULT_THEMES = [
        "åç›Šæ€§ã®æ”¹å–„",
        "ãƒ•ã‚¡ãƒ³åŒ–ã¨ç¶™ç¶šç‡ã®å‘ä¸Š",
        "å“è³ªã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã®ä¸¡ç«‹",
        "äººã¨å­¦ã³ã¸ã®æŠ•è³‡",
      ];

      const uid = () => Math.random().toString(36).slice(2, 9);

      function computePerspectiveScore(objs, perspective) {
        const kpis = objs.filter(o => o.perspective === perspective).flatMap(o => o.kpis);
        if (kpis.length === 0) return null;
        let totalWeight = 0;
        let acc = 0;
        for (const k of kpis) {
          const w = (k.weight ?? 0) / 100;
          if (!k.target || k.target === 0 || k.actual == null) continue;
          const raw = k.actual / k.target; // 1.0ã§ç›®æ¨™é”æˆ
          const clipped = Math.max(0, Math.min(raw, 1.2)); // ä¸Šé™120%
          acc += clipped * w;
          totalWeight += w;
        }
        if (totalWeight === 0) return null;
        return (acc / totalWeight) * 100; // 0-120%æƒ³å®š
      }

      function ragColor(p) {
        if (p == null) return "bg-gray-200 text-gray-600";
        if (p >= 100) return "bg-green-100 text-green-800";
        if (p >= 80) return "bg-yellow-100 text-yellow-800";
        return "bg-red-100 text-red-800";
      }

      function App() {
        const [bsc, setBSC] = useState({
          orgName: "ãƒ—ãƒ¬ã‚°ãƒªãƒƒã‚·ãƒ¥ï¼ˆä»®ï¼‰",
          vision: "å­¦ã³ã®æœ¬è³ªçš„ãªæ¥½ã—ã•ã§ã€å­ã©ã‚‚ã®æœªæ¥ã‚’æ‹“ã",
          fiscalYear: "2025",
          strategicThemes: DEFAULT_THEMES,
          objectives: [],
        });

        const [selectedPerspective, setSelectedPerspective] = useState("Financial");

        const byPerspective = useMemo(() => {
          const map = { Financial: [], Customer: [], Internal: [], Learning: [] };
          for (const o of bsc.objectives) map[o.perspective].push(o);
          return map;
        }, [bsc.objectives]);

        const scores = {
          Financial: computePerspectiveScore(bsc.objectives, "Financial"),
          Customer: computePerspectiveScore(bsc.objectives, "Customer"),
          Internal: computePerspectiveScore(bsc.objectives, "Internal"),
          Learning: computePerspectiveScore(bsc.objectives, "Learning"),
        };

        function addObjective(p) {
          const id = uid();
          const o = { id, title: "", perspective: p, kpis: [], initiatives: [] };
          setBSC(v => ({ ...v, objectives: [...v.objectives, o] }));
        }
        function removeObjective(id) {
          setBSC(v => ({ ...v, objectives: v.objectives.filter(o => o.id !== id) }));
        }
        function addKPI(objectiveId, partial = {}) {
          setBSC(v => ({
            ...v,
            objectives: v.objectives.map(o =>
              o.id === objectiveId
                ? { ...o, kpis: [...o.kpis, { id: uid(), name: "", unit: "", weight: 10, ...partial }] }
                : o,
            ),
          }));
        }
        function removeKPI(objectiveId, kpiId) {
          setBSC(v => ({
            ...v,
            objectives: v.objectives.map(o =>
              o.id === objectiveId ? { ...o, kpis: o.kpis.filter(k => k.id !== kpiId) } : o,
            ),
          }));
        }
        function addInitiative(objectiveId) {
          setBSC(v => ({
            ...v,
            objectives: v.objectives.map(o =>
              o.id === objectiveId ? { ...o, initiatives: [...o.initiatives, { id: uid(), title: "" }] } : o,
            ),
          }));
        }
        function removeInitiative(objectiveId, initId) {
          setBSC(v => ({
            ...v,
            objectives: v.objectives.map(o =>
              o.id === objectiveId ? { ...o, initiatives: o.initiatives.filter(i => i.id !== initId) } : o,
            ),
          }));
        }
        function suggestKPIs(objectiveId, perspective) {
          for (const d of KPI_SUGGESTIONS[perspective].slice(0, 3)) {
            addKPI(objectiveId, { name: d.name, unit: d.unit });
          }
        }
        function updateKPI(objectiveId, kpiId, patch) {
          setBSC(v => ({
            ...v,
            objectives: v.objectives.map(o =>
              o.id !== objectiveId ? o : { ...o, kpis: o.kpis.map(k => (k.id === kpiId ? { ...k, ...patch } : k)) },
            ),
          }));
        }
        function updateInitiative(objectiveId, initId, patch) {
          setBSC(v => ({
            ...v,
            objectives: v.objectives.map(o =>
              o.id !== objectiveId ? o : { ...o, initiatives: o.initiatives.map(i => (i.id === initId ? { ...i, ...patch } : i)) },
            ),
          }));
        }

        function exportJSON() {
          const blob = new Blob([JSON.stringify(bsc, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `BSC_${bsc.orgName}_${bsc.fiscalYear}.json`;
          a.click();
          URL.revokeObjectURL(url);
        }
        function escapeCSV(s) {
          const str = String(s ?? "");
          if (str.includes(",") || str.includes("\n") || str.includes('"')) {
            return '"' + str.replace(/"/g, '""') + '"';
          }
          return str;
        }
        function exportCSV() {
          const rows = [
            ["Perspective","Objective","KPI","Target","Actual","Weight","Unit","Datasource","Frequency"].join(","),
          ];
          for (const o of bsc.objectives) {
            for (const k of o.kpis) {
              rows.push([
                o.perspective,
                escapeCSV(o.title),
                escapeCSV(k.name),
                k.target ?? "",
                k.actual ?? "",
                k.weight ?? "",
                k.unit ?? "",
                k.datasource ?? "",
                k.frequency ?? "",
              ].join(","));
            }
          }
          const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `BSC_KPIs_${bsc.orgName}_${bsc.fiscalYear}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }
        function importJSON(e) {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(String(reader.result));
              setBSC(data);
            } catch {
              alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
          };
          reader.readAsText(file);
        }
        function numOrUndef(v) {
          const n = Number(v);
          return Number.isFinite(n) ? n : undefined;
        }

        return (
          <div className="min-h-screen w-full">
            <header className="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
              <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
                <div className="w-6 h-6 grid place-items-center rounded-md bg-gray-900 text-white text-xs">B</div>
                <h1 className="text-xl font-bold">BSC AIãƒ„ãƒ¼ãƒ«ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆï¼‰</h1>
                <span className="ml-auto flex gap-2">
                  <button onClick={exportJSON} className="px-3 py-1.5 rounded-xl border hover:bg-gray-50">JSON</button>
                  <button onClick={exportCSV} className="px-3 py-1.5 rounded-xl border hover:bg-gray-50">CSV</button>
                  <label className="px-3 py-1.5 rounded-xl border hover:bg-gray-50 cursor-pointer">
                    Import JSON
                    <input type="file" accept="application/json" className="hidden" onChange={importJSON}/>
                  </label>
                </span>
              </div>
            </header>

            <main className="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-3 gap-6">
              <section className="md:col-span-3 grid md:grid-cols-3 gap-4">
                <div className="p-4 rounded-2xl border bg-gray-50">
                  <label className="text-xs text-gray-500">çµ„ç¹”å</label>
                  <input className="w-full mt-1 px-3 py-2 rounded-xl border" value={bsc.orgName} onChange={e=>setBSC(v=>({...v, orgName: e.target.value}))}/>
                </div>
                <div className="p-4 rounded-2xl border bg-gray-50">
                  <label className="text-xs text-gray-500">ãƒ“ã‚¸ãƒ§ãƒ³</label>
                  <input className="w-full mt-1 px-3 py-2 rounded-xl border" value={bsc.vision} onChange={e=>setBSC(v=>({...v, vision: e.target.value}))}/>
                </div>
                <div className="p-4 rounded-2xl border bg-gray-50">
                  <label className="text-xs text-gray-500">å¹´åº¦</label>
                  <input className="w-full mt-1 px-3 py-2 rounded-xl border" value={bsc.fiscalYear} onChange={e=>setBSC(v=>({...v, fiscalYear: e.target.value}))}/>
                </div>
                <div className="md:col-span-3 p-4 rounded-2xl border bg-gray-50">
                  <label className="text-xs text-gray-500">æˆ¦ç•¥ãƒ†ãƒ¼ãƒï¼ˆæ”¹è¡Œã§è¿½åŠ ï¼‰</label>
                  <textarea className="w-full mt-1 px-3 py-2 rounded-xl border h-20" value={bsc.strategicThemes.join("\n")} onChange={e=>setBSC(v=>({...v, strategicThemes: e.target.value.split(/\n+/).filter(Boolean)}))}/>
                </div>
              </section>

              {/* Scorecards */}
              <section className="md:col-span-2 space-y-6">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {PERSPECTIVES.map(p => (
                    <button key={p.key} onClick={()=>setSelectedPerspective(p.key)}
                      className={`rounded-2xl border p-3 text-left hover:shadow-sm ${selectedPerspective===p.key?"ring-2 ring-black":""}`}>
                      <div className="text-xs text-gray-500">{p.label}</div>
                      <div className="flex items-center gap-2 mt-1">
                        <div className="w-2 h-2 rounded-full" style={{backgroundColor:p.color}}/>
                        <div className={`text-sm px-2 py-0.5 rounded ${ragColor(scores[p.key])}`}>{scores[p.key]==null?"â€”":`${scores[p.key].toFixed(0)}%`}</div>
                      </div>
                    </button>
                  ))}
                </div>

                <div className="rounded-2xl border">
                  <div className="p-3 border-b flex items-center gap-2">
                    <div>ğŸ¯</div>
                    <div className="font-semibold">{PERSPECTIVES.find(x=>x.key===selectedPerspective)?.label}ã®ç›®æ¨™</div>
                    <button onClick={()=>addObjective(selectedPerspective)} className="ml-auto px-3 py-1.5 rounded-xl border hover:bg-gray-50">ï¼‹ è¿½åŠ </button>
                  </div>

                  <div className="divide-y">
                    {byPerspective[selectedPerspective].length===0 && (
                      <div className="p-6 text-sm text-gray-500">ç›®æ¨™ï¼ˆObjectiveï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
                    )}
                    {byPerspective[selectedPerspective].map((o) => (
                      <div key={o.id} className="p-4">
                        <div className="flex gap-2 items-center">
                          <input className="flex-1 px-3 py-2 rounded-xl border" placeholder="ä¾‹: LTVã®æœ€å¤§åŒ–" value={o.title} onChange={e=>setBSC(v=>({...v, objectives: v.objectives.map(x=>x.id===o.id?{...x, title:e.target.value}:x)}))}/>
                          <button className="px-2 py-1 rounded-xl border hover:bg-gray-50" title="KPIå€™è£œã‚’è¿½åŠ " onClick={()=>suggestKPIs(o.id, o.perspective)}>âœ¨</button>
                          <button className="px-2 py-1 rounded-xl border hover:bg-gray-50" onClick={()=>removeObjective(o.id)}>ğŸ—‘</button>
                        </div>
                        <textarea className="w-full mt-2 px-3 py-2 rounded-xl border" placeholder="ç›®çš„ãƒ»ä»®èª¬ãƒ»æ ¹æ‹ ï¼ˆãªãœã“ã®ç›®æ¨™ã‹ï¼‰" value={o.rationale ?? ""} onChange={e=>setBSC(v=>({...v, objectives: v.objectives.map(x=>x.id===o.id?{...x, rationale:e.target.value}:x)}))}/>

                        {/* KPI table */}
                        <div className="mt-3 overflow-x-auto">
                          <table className="min-w-full text-sm">
                            <thead>
                              <tr className="text-left text-gray-500 border-b">
                                <th className="py-2 pr-2">KPI</th>
                                <th className="py-2 pr-2">å˜ä½</th>
                                <th className="py-2 pr-2">ç›®æ¨™</th>
                                <th className="py-2 pr-2">å®Ÿç¸¾</th>
                                <th className="py-2 pr-2">é‡ã¿(%)</th>
                                <th className="py-2 pr-2">é »åº¦</th>
                                <th className="py-2 pr-2">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</th>
                                <th className="py-2 pl-2">æ“ä½œ</th>
                              </tr>
                            </thead>
                            <tbody>
                              {o.kpis.map(k => (
                                <tr key={k.id} className="border-b">
                                  <td className="py-1 pr-2"><input className="w-56 px-2 py-1 rounded border" value={k.name} onChange={e=>updateKPI(o.id, k.id, { name:e.target.value })}/></td>
                                  <td className="py-1 pr-2"><input className="w-20 px-2 py-1 rounded border" value={k.unit ?? ""} onChange={e=>updateKPI(o.id, k.id, { unit:e.target.value })}/></td>
                                  <td className="py-1 pr-2"><input type="number" className="w-24 px-2 py-1 rounded border" value={k.target ?? ""} onChange={e=>updateKPI(o.id, k.id, { target: numOrUndef(e.target.value) })}/></td>
                                  <td className="py-1 pr-2"><input type="number" className="w-24 px-2 py-1 rounded border" value={k.actual ?? ""} onChange={e=>updateKPI(o.id, k.id, { actual: numOrUndef(e.target.value) })}/></td>
                                  <td className="py-1 pr-2"><input type="number" className="w-20 px-2 py-1 rounded border" value={k.weight ?? 10} onChange={e=>updateKPI(o.id, k.id, { weight: numOrUndef(e.target.value) })}/></td>
                                  <td className="py-1 pr-2">
                                    <select className="w-28 px-2 py-1 rounded border" value={k.frequency ?? "monthly"} onChange={e=>updateKPI(o.id, k.id, { frequency: e.target.value })}>
                                      <option value="weekly">æ¯é€±</option>
                                      <option value="monthly">æ¯æœˆ</option>
                                      <option value="quarterly">å››åŠæœŸ</option>
                                      <option value="yearly">å¹´æ¬¡</option>
                                    </select>
                                  </td>
                                  <td className="py-1 pr-2"><input className="w-44 px-2 py-1 rounded border" placeholder="ä¾‹: GA4: conversion" value={k.datasource ?? ""} onChange={e=>updateKPI(o.id, k.id, { datasource:e.target.value })}/></td>
                                  <td className="py-1 pl-2">
                                    <button className="px-2 py-1 rounded border hover:bg-gray-50" onClick={()=>removeKPI(o.id, k.id)}>ğŸ—‘</button>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                        <div className="mt-2">
                          <button onClick={()=>addKPI(o.id)} className="px-3 py-1.5 rounded-xl border hover:bg-gray-50 text-sm">ï¼‹ KPIè¿½åŠ </button>
                        </div>

                        {/* Initiatives */}
                        <div className="mt-4">
                          <div className="text-xs text-gray-500 mb-1">ä¸»ãªå–ã‚Šçµ„ã¿</div>
                          {o.initiatives.map(i => (
                            <div key={i.id} className="flex items-center gap-2 mb-2">
                              <input className="flex-1 px-3 py-2 rounded-xl border" placeholder="ä¾‹: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä½“é¨“ä¼šÃ—10å›/æœˆ" value={i.title} onChange={e=>updateInitiative(o.id, i.id, { title: e.target.value })}/>
                              <button className="px-2 py-1 rounded-xl border hover:bg-gray-50" onClick={()=>removeInitiative(o.id, i.id)}>ğŸ—‘</button>
                            </div>
                          ))}
                          <button onClick={()=>addInitiative(o.id)} className="px-3 py-1.5 rounded-xl border hover:bg-gray-50 text-sm">ï¼‹ å–ã‚Šçµ„ã¿è¿½åŠ </button>
                        </div>

                        {/* Dependencies */}
                        <div className="mt-3">
                          <div className="text-xs text-gray-500 mb-1">ã“ã®ç›®æ¨™ã¯æ¬¡ã®ç›®æ¨™ã«ä¾å­˜ï¼ˆä¸‹å±¤â†’ä¸Šå±¤ã¸ã®ã¤ãªãŒã‚Šï¼‰</div>
                          <DependencySelector bsc={bsc} currentId={o.id} value={o.dependsOn ?? []} onChange={(ids)=>setBSC(v=>({...v, objectives: v.objectives.map(x=>x.id===o.id?{...x, dependsOn: ids}:x)}))}/>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </section>

              {/* Strategy Map */}
              <section className="space-y-4">
                <div className="rounded-2xl border p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <div>â¡ï¸</div>
                    <div className="font-semibold">ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ãƒãƒƒãƒ—ï¼ˆç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</div>
                  </div>
                  <StrategyMap bsc={bsc}/>
                </div>

                <div className="rounded-2xl border p-3">
                  <div className="font-semibold mb-2">AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆä¸‹æ›¸ãç”Ÿæˆç”¨ï¼‰</div>
                  <PromptLibrary bsc={bsc}/>
                </div>
              </section>
            </main>

            <footer className="max-w-6xl mx-auto px-4 pb-10 text-xs text-gray-500">
              <div className="mt-6">Â© 2025 BSC Assistant â€” 1ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆï¼ˆReact + Tailwind + Babelï¼‰</div>
            </footer>
          </div>
        );
      }

      function StrategyMap({ bsc }) {
        const layers = ["Learning", "Internal", "Customer", "Financial"];
        const layerObjs = layers.map(p => bsc.objectives.filter(o => o.perspective === p));

        const width = 700;
        const rowHeight = 120;
        const padding = 16;
        const nodeW = 220;
        const nodeH = 64;

        const positions = {};
        layerObjs.forEach((objs, row) => {
          const gap = (width - padding * 2 - nodeW) / Math.max(1, (objs.length - 1) || 1);
          objs.forEach((o, idx) => {
            positions[o.id] = { x: padding + (objs.length === 1 ? (width - nodeW) / 2 : idx * gap), y: padding + row * rowHeight, p: o.perspective };
          });
        });

        function color(p) {
          return ({"Financial":"#0f766e","Customer":"#7c3aed","Internal":"#1d4ed8","Learning":"#b45309"})[p];
        }

        const edges = [];
        for (const o of bsc.objectives) {
          if (!o.dependsOn) continue;
          for (const d of o.dependsOn) edges.push({ from: d, to: o.id });
        }

        return (
          <div className="w-full overflow-x-auto">
            <svg width={width} height={padding * 2 + rowHeight * layers.length} className="bg-white rounded-2xl border">
              {/* edges */}
              {edges.map((e, i) => {
                const a = positions[e.from];
                const b = positions[e.to];
                if (!a || !b) return null;
                const x1 = a.x + nodeW;
                const y1 = a.y + nodeH / 2;
                const x2 = b.x;
                const y2 = b.y + nodeH / 2;
                const mx = (x1 + x2) / 2;
                return (
                  <g key={i}>
                    <path d={`M ${x1} ${y1} C ${mx} ${y1}, ${mx} ${y2}, ${x2} ${y2}`} fill="none" stroke="#94a3b8" strokeWidth={2} />
                    <polygon points={`${x2-6},${y2-4} ${x2-6},${y2+4} ${x2},${y2}`} fill="#94a3b8" />
                  </g>
                );
              })}
              {/* nodes */}
              {bsc.objectives.map(o => {
                const pos = positions[o.id];
                if (!pos) return null;
                return (
                  <g key={o.id}>
                    <rect x={pos.x} y={pos.y} rx={12} ry={12} width={nodeW} height={nodeH} fill={color(pos.p)} opacity="0.08" stroke={color(pos.p)} />
                    <foreignObject x={pos.x + 8} y={pos.y + 8} width={nodeW - 16} height={nodeH - 16}>
                      <div className="text-xs font-medium leading-tight" xmlns="http://www.w3.org/1999/xhtml">
                        <div className="line-clamp-2">{o.title || "(ç„¡é¡Œ)"}</div>
                      </div>
                    </foreignObject>
                  </g>
                );
              })}
              {/* labels */}
              {["å­¦ç¿’ã¨æˆé•·","å†…éƒ¨ãƒ—ãƒ­ã‚»ã‚¹","é¡§å®¢","è²¡å‹™"].map((lab, i) => (
                <text key={lab} x="8" y={padding + i * rowHeight - 6} fontSize="10" fill="#64748b">{lab}</text>
              ))}
            </svg>
          </div>
        );
      }

      function DependencySelector({ bsc, currentId, value = [], onChange }) {
        const opts = bsc.objectives.filter(o => o.id !== currentId);
        return (
          <div className="flex flex-wrap gap-2">
            {opts.map(o => {
              const checked = value.includes(o.id);
              return (
                <label key={o.id} className={`text-xs px-2 py-1 rounded-full border cursor-pointer ${checked?"bg-gray-900 text-white":"hover:bg-gray-50"}`}>
                  <input type="checkbox" className="hidden" checked={checked} onChange={(e)=>{
                    if (e.target.checked) onChange([...value, o.id]);
                    else onChange(value.filter(id=>id!==o.id));
                  }}/>
                  {({"Financial":"è²¡å‹™","Customer":"é¡§å®¢","Internal":"å†…éƒ¨ãƒ—ãƒ­ã‚»ã‚¹","Learning":"å­¦ç¿’ã¨æˆé•·"})[o.perspective]}ãƒ»{o.title || "(ç„¡é¡Œ)"}
                </label>
              );
            })}
          </div>
        );
      }

      function PromptLibrary({ bsc }) {
        const sys = `ã‚ãªãŸã¯BSCï¼ˆãƒãƒ©ãƒ³ã‚¹ãƒˆãƒ»ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ï¼‰ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚æ—¥æœ¬èªã§ã€éåº¦ã«æŠ½è±¡åŒ–ã›ãšã€å®Ÿå‹™ã§ä½¿ãˆã‚‹KPIãƒ»æ–½ç­–ãƒ»ä»®èª¬æ¤œè¨¼æ‰‹é †ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`;
        const org = `çµ„ç¹”: ${bsc.orgName}\nå¹´åº¦: ${bsc.fiscalYear}\nãƒ“ã‚¸ãƒ§ãƒ³: ${bsc.vision}\næˆ¦ç•¥ãƒ†ãƒ¼ãƒ: ${bsc.strategicThemes.join("ã€ ")}`;
        const askObjectives = `ä¸Šè¨˜ã®å‰æã‹ã‚‰ã€å„è¦–ç‚¹ï¼ˆå­¦ç¿’ã¨æˆé•·â†’å†…éƒ¨ãƒ—ãƒ­ã‚»ã‚¹â†’é¡§å®¢â†’è²¡å‹™ï¼‰ã®é †ã§ã€ç›®çš„ï¼ˆObjectiveï¼‰ã‚’3ã€œ5å€‹ãšã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚å„ç›®çš„ã«ã€å€™è£œKPI 3å€‹ã€æƒ³å®šæ–½ç­– 2å€‹ã€æˆåŠŸä»®èª¬ãƒ»ä»£æ›¿ä»®èª¬ã‚’ä»˜ã—ã¦ãã ã•ã„ã€‚`;
        const askKPIRefine = `ä»¥ä¸‹ã®æ—¢å­˜ã®ç›®æ¨™ã¨KPIã‚’æ‰¹åˆ¤çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€SMARTåŸºæº–ã¨å¯è¦³æ¸¬æ€§ã®è¦³ç‚¹ã‹ã‚‰æ”¹å–„æ¡ˆã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚é‡ã¿ã®åˆæœŸå€¤ï¼ˆ%ï¼‰ã‚‚ææ¡ˆã—ã¦ãã ã•ã„ã€‚\n${bsc.objectives.map(o=>`- [${o.perspective}] ${o.title} / KPI: ${o.kpis.map(k=>k.name).join("ã€ ")}`).join("\n")}`;
        const askInitiatives = `KPIé”æˆã®ãŸã‚ã®å››åŠæœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ï¼ˆWBSï¼‰ã‚’ã€é€±æ¬¡ã®æˆæœç‰©ãƒ™ãƒ¼ã‚¹ã§ä½œã£ã¦ãã ã•ã„ã€‚ãƒªã‚¹ã‚¯ãƒ»æŒ‡æ¨™ãƒ»æ„æ€æ±ºå®šãƒã‚¤ãƒ³ãƒˆã‚‚å«ã‚ã¦ãã ã•ã„ã€‚`;
        const fullPrompt = `ã€ã‚·ã‚¹ãƒ†ãƒ ã€‘\n${sys}\n\nã€å‰æã€‘\n${org}\n\nã€ä¾é ¼1ã€‘\n${askObjectives}\n\nã€ä¾é ¼2ã€‘\n${askKPIRefine}\n\nã€ä¾é ¼3ã€‘\n${askInitiatives}`;

        return (
          <div className="space-y-3 text-xs">
            <CopyBlock label="è¦ä»¶å®šç¾©â†’Objectiveç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" content={fullPrompt} />
            <CopyBlock label="æ—¢å­˜KPIã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ”¹å–„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" content={askKPIRefine} />
            <CopyBlock label="å››åŠæœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ä½œæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" content={askInitiatives} />
          </div>
        );
      }

      function CopyBlock({ label, content }) {
        const [copied, setCopied] = React.useState(false);
        return (
          <div className="border rounded-2xl p-3 bg-gray-50">
            <div className="flex items-center gap-2 mb-2">
              <div>âœ¨</div>
              <div className="font-medium">{label}</div>
              <button onClick={()=>{navigator.clipboard.writeText(content); setCopied(true); setTimeout(()=>setCopied(false), 1200);}} className="ml-auto px-2 py-1 text-xs rounded border hover:bg-white">{copied?"ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ":"ã‚³ãƒ”ãƒ¼"}</button>
            </div>
            <pre className="text-[11px] whitespace-pre-wrap leading-5">{content}</pre>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
